name: Build and Generate JAR

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [ '21' ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven

    - name: Display Java version
      run: java -version

    - name: Build with Maven
      run: mvn -B clean package -DskipTests
      env:
        MAVEN_OPTS: "--add-opens java.base/java.lang=ALL-UNNAMED"

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: diffchecker-jar-${{ matrix.java-version }}-${{ github.sha }}
        path: target/*.jar
        retention-days: 30

    - name: Generate Release Notes
      if: startsWith(github.ref, 'refs/tags/v')
      id: release_notes
      run: |
        echo "## ğŸš€ DiffChecker Release" > release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“¦ Contenido" >> release_notes.md
        echo "- JAR ejecutable: \`diffchecker-1.0.0-runner.jar\`" >> release_notes.md
        echo "- Java 21 requerido" >> release_notes.md
        echo "" >> release_notes.md
        echo "### â–¶ï¸ CÃ³mo Usar" >> release_notes.md
        echo "" >> release_notes.md
        echo "**1. Descargar el JAR desde esta release**" >> release_notes.md
        echo "" >> release_notes.md
        echo "**2. Ejecutar la aplicaciÃ³n:**" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "java -jar diffchecker-1.0.0-runner.jar" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "**3. Acceder a la aplicaciÃ³n:**" >> release_notes.md
        echo "- URL: \`http://localhost:8080\`" >> release_notes.md
        echo "- API Endpoint: \`POST http://localhost:8080/api/diff/compare\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“ Ejemplo de Uso (cURL)" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "curl -X POST http://localhost:8080/api/diff/compare \\" >> release_notes.md
        echo "  -H \"Content-Type: application/json\" \\" >> release_notes.md
        echo "  -d '{" >> release_notes.md
        echo "    \"antes\": \"Texto antiguo\"," >> release_notes.md
        echo "    \"despues\": \"Texto nuevo\"" >> release_notes.md
        echo "  }'" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ”— Endpoints Disponibles" >> release_notes.md
        echo "" >> release_notes.md
        echo "#### POST /api/diff/compare" >> release_notes.md
        echo "Compara dos textos y retorna HTML con las diferencias" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Request:**" >> release_notes.md
        echo "\`\`\`json" >> release_notes.md
        echo "{\"antes\": \"string\", \"despues\": \"string\"}" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Response:** HTML con diferencias resaltadas" >> release_notes.md
        echo "" >> release_notes.md
        echo "#### GET /api/diff/compare" >> release_notes.md
        echo "Compara dos textos usando parÃ¡metros query" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Query Params:**" >> release_notes.md
        echo "- \`antes\`: Texto original" >> release_notes.md
        echo "- \`despues\`: Texto modificado" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Ejemplo:**" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "GET /api/diff/compare?antes=antiguo&despues=nuevo" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“‹ Requisitos MÃ­nimos" >> release_notes.md
        echo "- Java 21 o superior" >> release_notes.md
        echo "- Puerto 8080 disponible (o configurable)" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ› Troubleshooting" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Puerto 8080 en uso:**" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "java -Dquarkus.http.port=9000 -jar diffchecker-1.0.0-runner.jar" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Ver logs detallados:**" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "java -Dquarkus.log.level=DEBUG -jar diffchecker-1.0.0-runner.jar" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        cat release_notes.md

    - name: Create GitHub Release (on tags)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: target/diffchecker-*.jar
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Success - Push to Master
      if: success() && github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: |
        echo "âœ… Build completed successfully on master branch!"
        echo "ğŸ“¦ JAR generated and available as artifact"

    - name: Build Success - Pull Request
      if: success() && github.event_name == 'pull_request'
      run: |
        echo "âœ… Build completed successfully for PR!"
        echo "ğŸ“¦ JAR generated and available as artifact"

    - name: Build Success - Tag Release
      if: success() && startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "âœ… Build completed successfully for release tag!"
        echo "ğŸš€ Release created with JAR artifacts and documentation"

    - name: Build Failure Notification
      if: failure()
      run: echo "âŒ Build failed! Check logs for details."
